package quadratic_residue1676

// ETSI TS 102 361-1 V2.5.1 (2017-10) - B.3.2  Quadratic residue (16,7,6)

// Quadratic Residue (16,7,6) Syndrome Table
// Maps 9-bit syndrome to 16-bit error pattern.
// 0xFFFF indicates uncorrectable.
//
//nolint:gochecknoglobals // static syndrome lookup table
var qr16_7_6_syndrome_table = [512]uint16{
	0x0000, 0x0001, 0x0002, 0x0003, 0x0004, 0x0005, 0x0006, 0xFFFF,
	0x0008, 0x0009, 0x000A, 0xFFFF, 0x000C, 0xFFFF, 0xFFFF, 0x8040,
	0x0010, 0x0011, 0x0012, 0xFFFF, 0x0014, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0018, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4100, 0xFFFF,
	0x0020, 0x0021, 0x0022, 0xFFFF, 0x0024, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0028, 0xFFFF, 0xFFFF, 0x1800, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0030, 0xFFFF, 0xFFFF, 0x0240, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x8200, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0040, 0x0041, 0x0042, 0xFFFF, 0x0044, 0xFFFF, 0xFFFF, 0x8008,
	0x0048, 0xFFFF, 0xFFFF, 0x8004, 0xFFFF, 0x8002, 0x8001, 0x8000,
	0x0050, 0xFFFF, 0xFFFF, 0x0220, 0xFFFF, 0x3000, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x8010,
	0x0060, 0xFFFF, 0xFFFF, 0x0210, 0xFFFF, 0x0480, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x8020,
	0xFFFF, 0x0202, 0x0201, 0x0200, 0xFFFF, 0xFFFF, 0xFFFF, 0x0204,
	0xFFFF, 0xFFFF, 0xFFFF, 0x0208, 0xFFFF, 0xFFFF, 0x2800, 0xFFFF,
	0x0080, 0x0081, 0x0082, 0xFFFF, 0x0084, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0088, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0090, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0600, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0x00A0, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0440, 0xFFFF, 0xFFFF,
	0xFFFF, 0x6000, 0x8400, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x2100,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0x00C0, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0420, 0xFFFF, 0xFFFF,
	0xFFFF, 0x0900, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x8080,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4800,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0x0404, 0x1100, 0xFFFF, 0x0401, 0x0400, 0xFFFF, 0x0402,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0408, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0x0280, 0xFFFF, 0x0410, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x5000, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0100, 0x0101, 0x0102, 0xFFFF, 0x0104, 0xFFFF, 0xFFFF, 0x1400,
	0x0108, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4010, 0xFFFF,
	0x0110, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4008, 0xFFFF,
	0xFFFF, 0xFFFF, 0x4004, 0xFFFF, 0x4002, 0xFFFF, 0x4000, 0x4001,
	0x0120, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0C00, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x2080,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4020, 0xFFFF,
	0x0140, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0x0880, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x8100,
	0xFFFF, 0xC000, 0x2400, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4040, 0xFFFF,
	0xFFFF, 0xFFFF, 0x1080, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4200, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0x0300, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0180, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x8800, 0xFFFF,
	0xFFFF, 0x0840, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0x1200, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x2020,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x4080, 0xFFFF,
	0xFFFF, 0xFFFF, 0x1040, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x2010,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x9000, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0x2004, 0xFFFF, 0x2002, 0x2001, 0x2000,
	0xFFFF, 0xFFFF, 0x0A00, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x2008,
	0xFFFF, 0x0808, 0x1020, 0xFFFF, 0x2200, 0xFFFF, 0xFFFF, 0xFFFF,
	0x0801, 0x0800, 0xFFFF, 0x0802, 0xFFFF, 0x0804, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0x0810, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0x1002, 0xFFFF, 0x1000, 0x1001, 0xFFFF, 0x0500, 0x1004, 0xFFFF,
	0xFFFF, 0x0820, 0x1008, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
	0xFFFF, 0xFFFF, 0x1010, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x2040,
	0xA000, 0xFFFF, 0xFFFF, 0x4400, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
}

type QuadraticResidue16_7_6 struct {
	Data   [7]byte
	Parity [9]byte
}

func NewQuadraticResidue16_7_6(bits [16]byte) *QuadraticResidue16_7_6 {
	qr := QuadraticResidue16_7_6{}
	copy(qr.Data[:], bits[:7])
	copy(qr.Parity[:], bits[7:16])

	return &qr
}

func ParityBits(bits [7]byte) [9]byte {
	parity := [9]byte{}

	// Multiplying the generator matrix with the given data bits.
	// See DMR AI spec. page 134.
	parity[0] = bits[1] ^ bits[2] ^ bits[3] ^ bits[4]
	parity[1] = bits[2] ^ bits[3] ^ bits[4] ^ bits[5]
	parity[2] = bits[0] ^ bits[3] ^ bits[4] ^ bits[5] ^ bits[6]
	parity[3] = bits[2] ^ bits[3] ^ bits[5] ^ bits[6]
	parity[4] = bits[1] ^ bits[2] ^ bits[6]
	parity[5] = bits[0] ^ bits[1] ^ bits[4]
	parity[6] = bits[0] ^ bits[1] ^ bits[2] ^ bits[5]
	parity[7] = bits[0] ^ bits[1] ^ bits[2] ^ bits[3] ^ bits[6]
	parity[8] = bits[0] ^ bits[2] ^ bits[4] ^ bits[5] ^ bits[6]

	return parity
}

func Check(bits [16]byte) bool {
	var data [7]byte
	copy(data[:], bits[:7])

	calcParity := ParityBits(data)
	for i := 0; i < 9; i++ {
		if calcParity[i] != bits[7+i] {
			return false
		}
	}
	return true
}

// Decode corrects up to 2 bit errors in the 16-bit codeword.
// Returns the corrected data words, number of errors corrected, and uncorrectable flag.
func Decode(bits [16]byte) ([16]byte, int, bool) {
	var data [7]byte
	copy(data[:], bits[:7])

	// Calculate syndrome
	calcParity := ParityBits(data)
	syndrome := 0
	for i := 0; i < 9; i++ {
		if calcParity[i] != bits[7+i] {
			syndrome |= (1 << (8 - i))
		}
	}

	if syndrome == 0 {
		return bits, 0, false
	}

	errPattern := qr16_7_6_syndrome_table[syndrome]
	if errPattern == 0xFFFF {
		return bits, 0, true // Uncorrectable
	}

	// Apply correction (error pattern: 1 = flip)
	var corrected [16]byte
	copy(corrected[:], bits[:])

	errorsCorrected := 0
	for i := 0; i < 16; i++ {
		if (errPattern & (1 << (15 - i))) != 0 {
			corrected[i] ^= 1
			errorsCorrected++
		}
	}

	return corrected, errorsCorrected, false
}
